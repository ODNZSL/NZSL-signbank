From: =?utf-8?q?Bartolom=C3=A9_S=C3=A1nchez_Salado?=
 <bartolome.salado@kiwi.com>
Date: Sun, 12 Dec 2021 18:26:03 +0100
Subject: Add support for Django 4 compatibility

Forwarded: https://github.com/Fantomas42/django-tagging/commit/6550f6c04c0d2d67049e8cc3263623811207c66d.patch
---
 .travis.yml       | 4 ++++
 tagging/models.py | 6 ++++--
 2 files changed, 8 insertions(+), 2 deletions(-)

diff --git a/.travis.yml b/.travis.yml
index 6a8073d..1b79bc7 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -2,6 +2,7 @@ language: python
 python:
     - 3.7
     - 3.8
+    - 3.9
 services:
     - postgresql
     - mysql
@@ -15,6 +16,9 @@ env:
     - DJANGO=3.0 DATABASE_ENGINE=sqlite
     - DJANGO=3.0 DATABASE_ENGINE=postgres
     - DJANGO=3.0 DATABASE_ENGINE=mysql
+    - DJANGO=4.0 DATABASE_ENGINE=sqlite
+    - DJANGO=4.0 DATABASE_ENGINE=postgres
+    - DJANGO=4.0 DATABASE_ENGINE=mysql
 
 install:
     - pip install -U setuptools zc.buildout
diff --git a/tagging/models.py b/tagging/models.py
index d16a61e..50995c8 100644
--- a/tagging/models.py
+++ b/tagging/models.py
@@ -5,6 +5,7 @@ from django.contrib.contenttypes.fields import GenericForeignKey
 from django.contrib.contenttypes.models import ContentType
 from django.db import connection
 from django.db import models
+from django.db.models.query_utils import Q
 from django.utils.encoding import smart_str
 from django.utils.translation import gettext_lazy as _
 
@@ -155,8 +156,9 @@ class TagManager(models.Manager):
             filters = {}
 
         queryset = model._default_manager.filter()
-        for f in filters.items():
-            queryset.query.add_filter(f)
+        for k, v in filters.items():
+            # Add support for both Django 4 and inferior versions
+            queryset.query.add_q(Q((k, v)))
         usage = self.usage_for_queryset(queryset, counts, min_count)
 
         return usage
